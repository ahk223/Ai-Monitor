// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
}

// =====================================
// CORE MODELS
// =====================================

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  password      String
  name          String?
  avatar        String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  workspaces    WorkspaceMember[]
  activityLogs  ActivityLog[]
}

model Workspace {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  members     WorkspaceMember[]
  categories  Category[]
  tags        Tag[]
  prompts     Prompt[]
  tweets      Tweet[]
  tools       Tool[]
  playbooks   Playbook[]
  activityLogs ActivityLog[]

  // Taxonomy Settings
  benefitTypes    TaxonomyItem[] @relation("BenefitTypes")
  contentTypes    TaxonomyItem[] @relation("ContentTypes")
  masteryLevels   TaxonomyItem[] @relation("MasteryLevels")
}

model WorkspaceMember {
  id          String   @id @default(uuid())
  role        Role     @default(MEMBER)
  createdAt   DateTime @default(now())
  
  userId      String
  workspaceId String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([userId, workspaceId])
}

enum Role {
  OWNER
  ADMIN
  MEMBER
}

model Category {
  id          String   @id @default(uuid())
  name        String
  color       String   @default("#6366f1")
  icon        String?
  createdAt   DateTime @default(now())
  
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  prompts     Prompt[]
  tweets      Tweet[]
  tools       Tool[]

  @@unique([workspaceId, name])
}

model Tag {
  id          String   @id @default(uuid())
  name        String
  createdAt   DateTime @default(now())
  
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  prompts     Prompt[]  @relation("PromptTags")
  tweets      Tweet[]   @relation("TweetTags")
  tools       Tool[]    @relation("ToolTags")
  playbooks   Playbook[] @relation("PlaybookTags")

  @@unique([workspaceId, name])
}

model TaxonomyItem {
  id          String   @id @default(uuid())
  name        String
  description String?
  order       Int      @default(0)
  
  // Polymorphic relation
  benefitWorkspaceId  String?
  contentWorkspaceId  String?
  masteryWorkspaceId  String?
  
  benefitWorkspace    Workspace? @relation("BenefitTypes", fields: [benefitWorkspaceId], references: [id], onDelete: Cascade)
  contentWorkspace    Workspace? @relation("ContentTypes", fields: [contentWorkspaceId], references: [id], onDelete: Cascade)
  masteryWorkspace    Workspace? @relation("MasteryLevels", fields: [masteryWorkspaceId], references: [id], onDelete: Cascade)
  
  tweets              Tweet[]    @relation("TweetBenefit")
  tweetsContent       Tweet[]    @relation("TweetContentType")
  toolMastery         Tool[]     @relation("ToolMastery")
}

// =====================================
// PROMPTS
// =====================================

model Prompt {
  id          String   @id @default(uuid())
  title       String
  description String?
  content     String   @db.Text
  rating      Float?
  usageCount  Int      @default(0)
  isArchived  Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  categoryId  String?
  category    Category? @relation(fields: [categoryId], references: [id])
  
  tags        Tag[]     @relation("PromptTags")
  versions    PromptVersion[]
  variables   PromptVariable[]
  tests       PromptTest[]
  usageLogs   UsageLog[]
  attachments Attachment[] @relation("PromptAttachments")
  
  // Relationships
  linkedTweets   Tweet[]    @relation("PromptTweets")
  linkedTools    Tool[]     @relation("PromptTools")
  playbookSteps  PlaybookStep[] @relation("StepPrompts")

  @@index([workspaceId])
  @@index([categoryId])
}

model PromptVersion {
  id          String   @id @default(uuid())
  version     Int
  content     String   @db.Text
  changeNote  String?
  createdAt   DateTime @default(now())
  
  promptId    String
  prompt      Prompt   @relation(fields: [promptId], references: [id], onDelete: Cascade)

  @@unique([promptId, version])
}

model PromptVariable {
  id           String   @id @default(uuid())
  name         String   // e.g., "language"
  description  String?
  defaultValue String?
  
  promptId     String
  prompt       Prompt   @relation(fields: [promptId], references: [id], onDelete: Cascade)

  @@unique([promptId, name])
}

model PromptTest {
  id          String   @id @default(uuid())
  input       String?  @db.Text
  output      String   @db.Text
  isSuccess   Boolean
  rating      Int?     // 1-5
  notes       String?
  model       String?  // Which AI model was used
  createdAt   DateTime @default(now())
  
  promptId    String
  prompt      Prompt   @relation(fields: [promptId], references: [id], onDelete: Cascade)
}

model UsageLog {
  id          String   @id @default(uuid())
  context     String?  // Project or context
  wasHelpful  Boolean?
  notes       String?
  createdAt   DateTime @default(now())
  
  promptId    String
  prompt      Prompt   @relation(fields: [promptId], references: [id], onDelete: Cascade)
}

// =====================================
// TWEETS / NOTES
// =====================================

model Tweet {
  id           String   @id @default(uuid())
  content      String   @db.Text
  sourceUrl    String?
  importance   String?  // Why is this important?
  howToUse     String?  // How to use it practically?
  rating       Float?
  isArchived   Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  workspaceId  String
  workspace    Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  categoryId   String?
  category     Category? @relation(fields: [categoryId], references: [id])
  
  benefitTypeId   String?
  benefitType     TaxonomyItem? @relation("TweetBenefit", fields: [benefitTypeId], references: [id])
  
  contentTypeId   String?
  contentType     TaxonomyItem? @relation("TweetContentType", fields: [contentTypeId], references: [id])
  
  tags         Tag[]     @relation("TweetTags")
  attachments  Attachment[] @relation("TweetAttachments")
  
  // Relationships
  linkedPrompts  Prompt[]   @relation("PromptTweets")
  linkedTools    Tool[]     @relation("TweetTools")
  playbookSteps  PlaybookStep[] @relation("StepTweets")

  @@index([workspaceId])
}

// =====================================
// TOOLS
// =====================================

model Tool {
  id            String   @id @default(uuid())
  name          String
  description   String?  @db.Text
  officialUrl   String?
  logoUrl       String?
  
  // Pre-requisites and tips
  prerequisites String?  @db.Text
  commonMistakes String? @db.Text
  bestPractices String?  @db.Text
  
  rating        Float?
  isArchived    Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  workspaceId   String
  workspace     Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  categoryId    String?
  category      Category? @relation(fields: [categoryId], references: [id])
  
  masteryLevelId String?
  masteryLevel   TaxonomyItem? @relation("ToolMastery", fields: [masteryLevelId], references: [id])
  
  tags          Tag[]     @relation("ToolTags")
  learningPaths LearningPath[]
  lessons       Lesson[]
  attachments   Attachment[] @relation("ToolAttachments")
  
  // Relationships
  linkedPrompts  Prompt[]   @relation("PromptTools")
  linkedTweets   Tweet[]    @relation("TweetTools")
  playbookSteps  PlaybookStep[] @relation("StepTools")

  @@index([workspaceId])
}

model LearningPath {
  id          String   @id @default(uuid())
  level       String   // beginner, intermediate, advanced
  title       String
  description String?
  order       Int      @default(0)
  
  toolId      String
  tool        Tool     @relation(fields: [toolId], references: [id], onDelete: Cascade)
}

model Lesson {
  id          String   @id @default(uuid())
  title       String
  description String?
  order       Int      @default(0)
  
  // Content links
  youtubeUrl  String?
  twitterUrl  String?
  webUrl      String?
  
  isCompleted Boolean  @default(false)
  createdAt   DateTime @default(now())
  
  toolId      String
  tool        Tool     @relation(fields: [toolId], references: [id], onDelete: Cascade)
}

// =====================================
// PLAYBOOKS
// =====================================

model Playbook {
  id          String   @id @default(uuid())
  title       String
  description String?  @db.Text
  rating      Float?
  usageCount  Int      @default(0)
  isArchived  Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  tags        Tag[]     @relation("PlaybookTags")
  steps       PlaybookStep[]

  @@index([workspaceId])
}

model PlaybookStep {
  id          String   @id @default(uuid())
  title       String
  description String?  @db.Text
  order       Int      @default(0)
  
  playbookId  String
  playbook    Playbook @relation(fields: [playbookId], references: [id], onDelete: Cascade)
  
  // Linked entities
  prompts     Prompt[]   @relation("StepPrompts")
  tools       Tool[]     @relation("StepTools")
  tweets      Tweet[]    @relation("StepTweets")

  @@index([playbookId])
}

// =====================================
// ATTACHMENTS
// =====================================

model Attachment {
  id          String   @id @default(uuid())
  filename    String
  originalName String
  mimeType    String
  size        Int
  url         String
  createdAt   DateTime @default(now())
  
  promptId    String?
  prompt      Prompt?  @relation("PromptAttachments", fields: [promptId], references: [id], onDelete: Cascade)
  
  tweetId     String?
  tweet       Tweet?   @relation("TweetAttachments", fields: [tweetId], references: [id], onDelete: Cascade)
  
  toolId      String?
  tool        Tool?    @relation("ToolAttachments", fields: [toolId], references: [id], onDelete: Cascade)
}

// =====================================
// ACTIVITY LOG
// =====================================

model ActivityLog {
  id          String   @id @default(uuid())
  action      String   // CREATE, UPDATE, DELETE, VIEW, USE
  entityType  String   // Prompt, Tweet, Tool, Playbook
  entityId    String
  entityTitle String?
  metadata    Json?
  createdAt   DateTime @default(now())
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([entityType, entityId])
}
